<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSU ODF Details Kurunegala</title>
    <link rel="stylesheet" href="style.css">
    
</head>
<body class="landing">
    <header class="landing-hero">
        <div class="landing-brand">
            <img class="landing-logo" src="SLTMobitel_Logo.svg.png" alt="SLT Mobitel">
            <div>
                <h1>RSU ODF Details Kurunegala</h1>
                <p>Select a region to view its sub ODFs.</p>
            </div>
        </div>
        <div class="nav-controls"></div>
    </header>

    <main class="landing-content">
        <section class="search-panel" aria-label="Search stored ODF data">
            <div class="search-panel-header">
                <h2>Search Stored Data</h2>
                <p>Search any keyword in saved ODF data and open the matched storage path.</p>
            </div>
            <div class="search-controls">
                <input id="globalSearchInput" class="input" type="text" placeholder="Type keyword (e.g., KLY, PORT-001, ACTIVE)">
                <button id="globalSearchBtn" class="btn btn-primary" type="button">Search</button>
            </div>
            <div id="searchStatus" class="small-text"></div>
            <div id="searchResults" class="search-results" aria-live="polite"></div>
        </section>
        <section class="regions-grid">
            <a class="region-card region-link" href="subregions.html?region=Alawwa%20(AB)">
                <div class="region-header"><h2>Alawwa (AB)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Dambadeniya%20(DMB)">
                <div class="region-header"><h2>Dambadeniya (DMB)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Galgamuwa%20(GGM)">
                <div class="region-header"><h2>Galgamuwa (GGM)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Giriulla%20(GU)">
                <div class="region-header"><h2>Giriulla (GU)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Hettipola%20(HZ)">
                <div class="region-header"><h2>Hettipola (HZ)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Ibbagamuwa%20(IBG)">
                <div class="region-header"><h2>Ibbagamuwa (IBG)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Kurunegala%20(KG)">
                <div class="region-header"><h2>Kurunegala (KG)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Kuliyapitiya%20(KLY)">
                <div class="region-header"><h2>Kuliyapitiya (KLY)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Mawathagama%20(MG)">
                <div class="region-header"><h2>Mawathagama (MG)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Mahawa%20(MQ)">
                <div class="region-header"><h2>Mahawa (MQ)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Narammala%20(NC)">
                <div class="region-header"><h2>Narammala (NC)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Nikadalupotha%20(NDP)">
                <div class="region-header"><h2>Nikadalupotha (NDP)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Nikaweratiya%20(NK)">
                <div class="region-header"><h2>Nikaweratiya (NK)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Pannala%20(PL)">
                <div class="region-header"><h2>Pannala (PL)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Pothuhera%20(PTR)">
                <div class="region-header"><h2>Pothuhera (PTR)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Polgahawela%20(PW)">
                <div class="region-header"><h2>Polgahawela (PW)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Ridigama%20(RGM)">
                <div class="region-header"><h2>Ridigama (RGM)</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Thulhiriya%20Cabin">
                <div class="region-header"><h2>Thulhiriya Cabin</h2></div>
            </a>
            <a class="region-card region-link" href="subregions.html?region=Wariyapola%20(WP)">
                <div class="region-header"><h2>Wariyapola (WP)</h2></div>
            </a>
        </section>
    </main>
    <footer class="page-footer">Â© 2026 SLT Mobitel Pvt Ltd. All Right Reserved</footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('globalSearchInput');
            const button = document.getElementById('globalSearchBtn');
            const status = document.getElementById('searchStatus');
            const resultsBox = document.getElementById('searchResults');
            if (!input || !button || !status || !resultsBox) {
                return;
            }

            const escapeHtml = (value) => String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

            const renderResults = (items) => {
                if (!Array.isArray(items) || items.length === 0) {
                    resultsBox.innerHTML = '<div class="search-empty">No matching data found in storage.</div>';
                    return;
                }

                const html = items.map((item) => {
                    const region = escapeHtml(item.region || 'Unknown Region');
                    const sub = escapeHtml(item.sub || 'Unknown Sub ODF');
                    const link = escapeHtml(item.exactLink || item.link || '#');
                    const path = escapeHtml(item.jsonPath || '');
                    const value = escapeHtml(item.matchedValue || '');
                    const portNum = Number(item.portNumber);
                    const hasPort = Number.isInteger(portNum) && portNum > 0;
                    const locationLabel = hasPort ? `Port ${portNum}` : 'ODF Level';
                    return `
                        <article class="search-result-item">
                            <div class="search-result-top">
                                <a class="search-result-link" href="${link}">${region} | ${sub}</a>
                            </div>
                            <div class="search-result-port">${locationLabel}</div>
                            <div class="search-result-path"><code>${path}</code></div>
                            <div class="search-result-value">${value}</div>
                        </article>
                    `;
                }).join('');

                resultsBox.innerHTML = html;
            };

            const clipText = (value, maxLen = 160) => {
                const text = String(value ?? '').replace(/\s+/g, ' ').trim();
                if (text.length <= maxLen) return text;
                return `${text.slice(0, maxLen - 3)}...`;
            };

            const localSearch = (data, keyword) => {
                const keywordLower = keyword.toLowerCase();
                const results = [];
                const limit = 100;
                const odf = data && typeof data.odf === 'object' ? data.odf : {};

                const extractPortNumber = (tokens) => {
                    for (let i = 0; i < tokens.length - 1; i++) {
                        if (tokens[i] !== 'ports') continue;
                        const index = tokens[i + 1];
                        if (typeof index === 'number' && Number.isInteger(index) && index >= 0) {
                            return index + 1;
                        }
                    }
                    return null;
                };

                const pushResult = (region, sub, storageKey, jsonPath, valueText, portNumber = null) => {
                    if (results.length >= limit) return;
                    let exactLink = `odf.html?region=${encodeURIComponent(region)}&sub=${encodeURIComponent(sub)}`;
                    if (Number.isInteger(portNumber) && portNumber > 0) {
                        exactLink += `&port=${portNumber}`;
                    }
                    results.push({
                        region,
                        sub,
                        link: exactLink,
                        exactLink,
                        portNumber,
                        jsonPath,
                        matchedValue: clipText(valueText)
                    });
                };

                const walk = (value, tokens, region, sub, storageKey) => {
                    if (results.length >= limit || value === null || value === undefined) return;

                    if (Array.isArray(value)) {
                        value.forEach((item, index) => walk(item, [...tokens, index], region, sub, storageKey));
                        return;
                    }

                    if (typeof value === 'object') {
                        Object.entries(value).forEach(([k, v]) => walk(v, [...tokens, k], region, sub, storageKey));
                        return;
                    }

                    const raw = String(value);
                    if (!raw.toLowerCase().includes(keywordLower)) return;

                    let path = `odf["${storageKey.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"]`;
                    tokens.forEach((token) => {
                        if (typeof token === 'number') {
                            path += `[${token}]`;
                        } else if (/^[A-Za-z_$][A-Za-z0-9_$]*$/.test(token)) {
                            path += `.${token}`;
                        } else {
                            const safeKey = String(token).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
                            path += `["${safeKey}"]`;
                        }
                    });

                    const portNumber = extractPortNumber(tokens);
                    pushResult(region, sub, storageKey, path, raw, portNumber);
                };

                Object.entries(odf).forEach(([storageKey, entry]) => {
                    if (results.length >= limit) return;
                    const parts = storageKey.split('||');
                    const region = (entry && entry.region) || (parts[0] || 'Unknown Region');
                    const sub = (entry && entry.sub) || (parts.slice(1).join('||') || 'Unknown Sub ODF');

                    const meta = `${storageKey} ${region} ${sub}`;
                    if (meta.toLowerCase().includes(keywordLower)) {
                        pushResult(region, sub, storageKey, `odf["${storageKey.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"]`, meta, null);
                    }

                    walk(entry, [], region, sub, storageKey);
                });

                return { total: results.length, items: results };
            };

            const runSearch = async () => {
                const keyword = input.value.trim();
                if (!keyword) {
                    status.textContent = 'Enter a keyword to search.';
                    resultsBox.innerHTML = '';
                    input.focus();
                    return;
                }

                button.disabled = true;
                status.textContent = `Searching for "${keyword}"...`;

                try {
                    const res = await fetch(`/api/search?keyword=${encodeURIComponent(keyword)}`);
                    if (res.ok) {
                        const data = await res.json();
                        const count = Number(data.total) || 0;
                        status.textContent = `${count} result${count === 1 ? '' : 's'} found for "${keyword}".`;
                        renderResults(data.items);
                        return;
                    }
                } catch {
                    // Fall back to direct file search when API is unavailable.
                }

                try {
                    const dataRes = await fetch('data.json', { cache: 'no-store' });
                    if (!dataRes.ok) {
                        throw new Error('Cannot load data.json');
                    }
                    const rawData = await dataRes.json();
                    const local = localSearch(rawData, keyword);
                    const count = Number(local.total) || 0;
                    status.textContent = `${count} result${count === 1 ? '' : 's'} found for "${keyword}" (local file search).`;
                    renderResults(local.items);
                } catch {
                    status.textContent = 'Search failed. Please run with server.js or allow data.json access.';
                    resultsBox.innerHTML = '<div class="search-empty">Unable to query storage right now.</div>';
                } finally {
                    button.disabled = false;
                }
            };

            button.addEventListener('click', runSearch);
            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    runSearch();
                }
            });
        });
    </script>
</body>
</html>
